@{
    ViewData["Title"] = "Live Results";
    var qsEventId = Context.Request.Query["eventId"].FirstOrDefault() ?? "1";
}

<h2 class="mt-3 mb-3 text-center">🏁 Live Results</h2>

<div class="d-flex gap-2 align-items-end mb-3">
    <div style="max-width:200px">
        <label class="form-label">Събитие ID</label>
        <input id="eventIdInput" class="form-control" value="@qsEventId" />
    </div>
    <button class="btn btn-primary" onclick="reload()">Зареди</button>
    <a class="btn btn-outline-secondary" href="/EventsUi">Състезания</a>
</div>

<table id="resultsTable" class="table table-striped text-center align-middle">
    <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>Име</th>
            <th>Отбор</th>
            <th>Време</th>
            <th>+Наказ.</th>
            <th>Общо</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script>
    // ---- helpers ----
    function currentEventId() {
        const v = document.getElementById('eventIdInput').value?.trim() || "1";
        return parseInt(v, 10);
    }

    // ---- data ----
    async function loadStandings() {
        const id = currentEventId();
        const res = await fetch(`/api/Results/standings/${id}`);
        if (!res.ok) {
            console.error("Standings error", res.status);
            renderStandings([]);
            return;
        }
        const data = await res.json();
        renderStandings(data);
    }

    function renderStandings(list) {
        const tbody = document.querySelector("#resultsTable tbody");
        tbody.innerHTML = "";
        if (!Array.isArray(list) || list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6">Няма класиране.</td></tr>`;
            return;
        }
        list.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                    <td>${r.number}</td>
                    <td>${r.name}</td>
                    <td>${r.team}</td>
                    <td>${r.lapTime}</td>
                    <td>${r.penaltySeconds}s</td>
                    <td><strong>${r.adjustedLapTime}</strong></td>
                `;
            tbody.appendChild(tr);
        });
    }

    function reload() {
        // ако сменим eventId ръчно, презаписваме абонамента към правилната група
        const id = String(currentEventId());
        connection.invoke("UnsubscribeFromEvent", id).catch(() => { });
        connection.invoke("SubscribeToEvent", id).catch(() => { });
        loadStandings();
    }

    // ---- SignalR ----
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/timingHub")
        .build();

    connection.on("NewResult", () => loadStandings());
    connection.on("PenaltyUpdated", () => loadStandings());

    connection.start()
        .then(() => {
            console.log("✅ Свързано с TimingHub");
            connection.invoke("SubscribeToEvent", String(currentEventId())).catch(console.error);
            loadStandings();
        })
        .catch(err => console.error("❌ SignalR:", err));
</script>
